<tool id="cialign" name="CIAlign" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" python_template_version="3.6" profile="21.05">
    <description>
        CIAlign a tool to clean, visualise and analyse a multiple sequence alignment
    </description>
    <!-- Import -->
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <version_command>cialign --version</version_command>
    <command detect_errors="exit_code"><![CDATA[
        CIAlign --infile $input
                --outfile_stem $prefix

                ###### Basic Options
                #if $basic_options.inifile
                    --inifile '$basic_options.inifile'
                #end if
                $basic_options.all
                $basic_options.clean
                $basic_options.visualise
                $basic_options.interpret
                $basic_options.silent
                
                ###### Remove Divergent options
                #if str($remove_divergent_cond.remove_divergent_param) == "true": 
                    --remove_divergent
                    #if $remove_divergent_cond.remove_divergent_retain:
                        --remove_divergent_retain "$remove_divergent_cond.remove_divergent_retain"
                    #end if
                    #if $remove_divergent_cond.remove_divergent_retain_str:
                        --remove_divergent_retain_str "$remove_divergent_cond.remove_divergent_retain_str"
                    #end if
                    #if $remove_divergent_cond.remove_divergent_retain_list:
                        --remove_divergent_retain_list '$remove_divergent_cond.remove_divergent_retain_list'
                    #end if
                #end if

                ###### Remove Insertions options
                #if str($remove_insertions_cond.remove_insertions_param) == "true": 
                    --remove_insertions
                    --insertion_min_size $remove_insertions_cond.insertion_min_size
                    --insertion_max_size $remove_insertions_cond.insertion_max_size
                    --insertion_min_flank $remove_insertions_cond.insertion_min_flank
                    --insertion_min_perc $remove_insertions_cond.insertion_min_perc
                #end if

                ###### Crop Ends options
                #if str($crop_ends_cond.crop_ends_param) == "true":
                    --crop_ends
                #end if

    ]]></command>
    <inputs>
        <param name="input" type="data" format="fasta"/>
        <param name="prefix" type="text" value="CIAlign" label="output data prefix:"/>
        <!-- BASIC options -->
        <section name="basic_options" title="Basic Options" expanded="true">
            <param argument="--inifile" type="data" format="ini" optional="true" label="config file" help="Upload a config file with all the needed settings and parameters" />
            <param argument="--all" type="boolean" truevalue="--all" falsevalue="" checked="false" label="Use all options" help="Use all available functions, with default parameters unless others are specified."/>
            <param argument="--clean" type="boolean" truevalue="--clean" falsevalue="" checked="false" label="Use all clean options" help="Use all cleaning functions, with default parameters unless others are specified."/>
            <param argument="--visualise" type="boolean" truevalue="--visualise" falsevalue="" checked="false" label="Plot all mini alignments" help="Plot all mini alignments, with default parameters unless others are specified."/>
            <param argument="--interpret" type="boolean" truevalue="--interpret" falsevalue="" checked="false" label="Use all interpretation functions" help="Use all interpretation functions, with default parameters unless others are specified."/>
            <param argument="--silent" type="boolean" truevalue="--silent" falsevalue="" checked="false" label="Do not print progress to the screen." help="Do not print progress to the screen."/>
        </section>
        <!-- Remove divergent options -->
        <conditional name="remove_divergent_cond">
            <param name="remove_divergent_param" type="select" label="Remove sequences with fewer than the specified proportion?">
                <option value="true" >yes</option>
                <option value="false" selected="true">option is not used</option>
            </param>            
            <when value="true">
                <!-- Remove divergent sub parameters -->
                <param argument="--remove_divergent_minperc" type="float" value="0.65" min="0" max="1" label="Minimum proportion" help="Minimum proportion of positions which should be identical to the most common base / amino acid in order to be preserved"/>
                <param argument="--remove_divergent_retain" type="text" value="" label="Retain sequences with this name" help="Do not remove sequences with this name when running remove divergent"/>
                <param argument="--remove_divergent_retain_str" type="text" value="" label="Retain sequences with names containing this character string" help="Do not remove sequences with this string when running divergent"/>            
                <param argument="--remove_divergent_retain_list" type="file" format="text" value="" optional="true" label="Do not remove sequences with names listed in this file:" help="Sequences names listed in the file won't be removed"/>            
            </when>
        </conditional>
        <!-- Remove Insertions options -->
        <conditional name="remove_insertions_cond">
            <param name="remove_insertions_param" type="select" label="Removes insertions which are not present in the majority of sequences?">
                <option value="true" >yes</option>
                <option value="false" selected="true">option is not used</option>
            </param>            
            <when value="true">
                <!-- Remove insertions sub parameters -->
                <param argument="--insertion_min_size" type="integer" value="3" min="1" label="Minimum size: " help="Only remove insertions bigger than this number of residues. Must be less than or equal to the number of columns in your alignment (i.e. sequence length)."/>
                <param argument="--insertion_max_size" type="integer" value="200" min="1" max="10000" label="Maximum size: " help="Only remove insertions smaller than this number of residues."/>
                <param argument="--insertion_min_flank" type="integer" value="5" min="0"  label="Minimum flank: " help="Minimum number of bases on either side of an insertion to classify it as an insertion. This value must be less than half the number of columns (alignment length) in your input file."/>            
                <param argument="--insertion_min_perc" type="float" value="0.5" min="0" max="1" label="Percent: " help="Remove insertions which are present in less than this proportion of sequences."/>            
            </when>
        </conditional>
        <!-- Crop Ends options -->
        <conditional name="crop_ends_cond">
            <param name="crop_ends_param" type="select" label="Crop the ends of individual sequences?" help="Crop the ends of sequences if they are poorly aligned.">
                <option value="true" >yes</option>
                <option value="false" selected="true">option is not used</option>
            </param>            
            <when value="true">
                <!-- Crop Ends sub parameters -->
            </when>
        </conditional>
        
        
        <!-- OUTPUT options -->
        <section name="output" title="Output" expanded="false">
            <param name="input_png" type="boolean" checked="false" label="Outputs input png file?"/>
            <param name="output_png" type="boolean" checked="false" label="Outputs input png file?"/>
        </section>
    </inputs>
    
    <!-- TOOL Outputs-->
    <outputs>
        <data name="cleaned" format="fasta" from_work_dir="${prefix}_cleaned.fasta" label="${tool.name} on ${on_string}: Cleaned Alignment"/>
        <data name="removed" format="txt" from_work_dir="${prefix}_removed.txt" label="${tool.name} on ${on_string}: Removed Sequences"/>
        <data name="log" format="txt" from_work_dir="${prefix}_log.txt" label="${tool.name} on ${on_string}: Log File"/>
        <data name="input_png" format="png" from_work_dir="${prefix}_input.png" label="${tool.name} on ${on_string}: image representing the input alignment">
            <filter>output['input_png']</filter>
        </data>
        <data name="output_png" format="png" from_work_dir="${prefix}_output.png" label="${tool.name} on ${on_string}: image representing the output alignment">
            <filter>output['output_png']</filter>
        </data>
    </outputs>
    <!-- include tests-->
    <expand macro="tests"/>
    <!-- include help--> 
    <expand macro="help"/>
    <citations>
        <citation type="bibtex">
            @misc{githubCIAlign,
            author = {LastTODO, FirstTODO},
            year = {TODO},
            title = {CIAlign},
            publisher = {GitHub},
            journal = {GitHub repository},
            url = {https://github.com/KatyBrown/CIAlign},}
            </citation>
    </citations>
</tool>